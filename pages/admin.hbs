<div class="d-flex align-items-start">
  <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
    <button onclick="inp_tb2()" class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill" data-bs-target="#v-pills-home" type="button" role="tab" aria-controls="v-pills-home" aria-selected="true">xlsx</button>
    <button onclick="inp_tb()" class="nav-link" id="v-pills-profile-tab" data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab" aria-controls="v-pills-profile" aria-selected="false">input</button>
    <button onclick="inp_tb1()" class="nav-link" id="v-pills-messages-tab" data-bs-toggle="pill" data-bs-target="#v-pills-messages" type="button" role="tab" aria-controls="v-pills-messages" aria-selected="false">download xlsx</button>
    <button onclick="pokypka()" class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" data-bs-target="#v-pills-settings" type="button" role="tab" aria-controls="v-pills-settings" aria-selected="false">Pokypka</button>
  </div>
  <div class="tab-content" id="v-pills-tabContent">
    <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">
        <h2 id='sel_tab2'>select table</h2>
        {{!-- <form action="/admin/xlsx" enctype="multipart/form-data" method="POST">
            <div class="input-group mb-3">
                <button class="btn btn-outline-secondary" type="submit" id="inputGroupFileAddon03">Button</button>
                <input type="file"  name="xlsx1" class="form-control" id="inputGroupFile03" aria-describedby="inputGroupFileAddon03" aria-label="Upload">
            </div>
        </form> --}}
    </div>
    <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
        <h2 id='sel_tab'>select table</h2>
    </div>
    <div class="tab-pane fade" id="v-pills-messages" role="tabpanel" aria-labelledby="v-pills-messages-tab">
        <h2 id='sel_tab1'>select table</h2>
    </div>
    <div class="tab-pane fade" id="v-pills-settings" role="tabpanel" aria-labelledby="v-pills-settings-tab">
        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">заказ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="main-modal_content">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">закрити</button>
        <button type="button" class="btn btn-primary" onclick="PrintMe('main-modal_content')" >друк</button>
        <button type="button" class="btn btn-success" onclick="done(this)">Виконати</button>
      </div>
    </div>
  </div>
</div>

    </div>
  </div>
</div>
<script>
    
function splitString(stringToSplit, separator) {
    const arrayOfStrings = stringToSplit.split(separator);
    return(arrayOfStrings);
} 

let main_obj = {
    input1:function(x){
        let json_data = JSON.parse(x)
        let select = '<select id="insel_tab" class="form-select form-select-sm" aria-label=".form-select-sm example">'
        for(let i = 0;i<json_data.length;i++){
            select+= '<option value="'+json_data[i].table_name+'">'+json_data[i].table_name+'</option>';
        }
        select+='</select><button type="button" onclick="select_bttn()" class="btn btn-primary" style="margin-top: 1rem;margin-bottom: 3rem;">Select</button>';
        let inn = document.getElementById('v-pills-profile');
        inn.innerHTML = "<h2 id='sel_tab'>select table</h2>";
        let sel_tab = document.getElementById('sel_tab');
        sel_tab.insertAdjacentHTML('afterend', select);
    },
    input2:function(x,y){
        let json_tabs = JSON.parse(x);
        let form = '<form method="POST" id="forma_vidpr" tb_name="'+y+'">';
        for(let i = 0;i<json_tabs.length;i++){
            form+=`<div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon1">`+json_tabs[i].column_name+`</span>
                    <input type="text" class="form-control" name="`+json_tabs[i].column_name+`" aria-describedby="basic-addon1">
                   </div>`
        }
        form+='<button type="button" onclick="insert_bttn()" class="btn btn-primary" style="margin-top: 1rem;">Input</button></form>';
        console.log(form)
        let vstavka = document.getElementById('v-pills-profile');
        vstavka.insertAdjacentHTML('beforeend', form);
    },
    input3:function(x){
        let json_tabs = JSON.parse(x);
        //console.log(json_tabs);
        let select = '<select id="insel_tab1" class="form-select form-select-sm" aria-label=".form-select-sm example">'
        for(let i = 0;i<json_tabs.length;i++){
            select+= '<option value="'+json_tabs[i].table_name+'">'+json_tabs[i].table_name+'</option>';
        }
        select+='</select><button type="button" onclick="select_bttn1()" class="btn btn-primary" style="margin-top: 1rem;margin-bottom: 3rem;">Select</button>';
        let vstavka = document.getElementById('v-pills-home');
        vstavka.insertAdjacentHTML('beforeend', select);
    },
    xlsx_input:function(x){
        let json_data = JSON.parse(x);
        let select = '<select id="insel_tab1" class="form-select form-select-sm" aria-label=".form-select-sm example">'
        for(let i = 0;i<json_data.length;i++){
            select+= '<option value="'+json_data[i].table_name+'">'+json_data[i].table_name+'</option>';
        }
        select+='</select><button type="button" onclick="xlsx_bttn()" id="xlsx_bttn" class="btn btn-primary" style="margin-top: 1rem;margin-bottom: 3rem;">Select</button>';
        let inn = document.getElementById('v-pills-messages');
        inn.innerHTML = "<h2 id='sel_tab1'>select table</h2>";
        let sel_tab1 = document.getElementById('sel_tab1');
        sel_tab1.insertAdjacentHTML('afterend', select);
        console.log(select)
    },
    check_list:function(x,y){
        let tabs = JSON.parse(x);
        let list = '<form id="list" tb_name="'+y+'">';
        for(let i = 0;i<tabs.length;i++){
            list+= `<input type="text" class="form-control" placeholder='`+tabs[i].column_name+`' name="`+tabs[i].column_name+`" aria-describedby="basic-addon1">`;
        }
        list+='<button type="button" onclick="check_()" class="btn btn-primary" style="margin-top: 1rem;">Input</button></form>';
        let vstavka = document.getElementById('v-pills-home');
        vstavka.insertAdjacentHTML('beforeend', list);
    }
}

function insert_bttn(){
    let forma = document.getElementById('forma_vidpr');
    let table_name = forma.getAttribute('tb_name');
    console.log('tb_name ', table_name)
    let data = new Map()
    data.set("table",table_name);
    console.log('---------------')
    for(let i = 0;i<forma.childNodes.length-1;i++){
        data.set(forma.childNodes[i].childNodes[1].innerHTML,forma.childNodes[i].childNodes[3].value);
    }
    let obj = Object.fromEntries(data);
    data = JSON.stringify(obj);
    let request2 = new XMLHttpRequest();
    request2.open("POST", "/admin/insert", true);   
    request2.setRequestHeader("Content-Type", "application/json");
    request2.addEventListener("load", function () {
        console.log(request2.responseText)
    });
    request2.send(data);
}

function select_bttn(){
    let select_form = document.getElementById('insel_tab');
    let request1 = new XMLHttpRequest();
    let data1 =JSON.stringify({
        "content" : select_form.value
    });
    request1.open("POST", "/admin/polyatabl", true);   
    request1.setRequestHeader("Content-Type", "application/json");
    request1.addEventListener("load", function () {
        main_obj.input2(request1.response,select_form.value);
    });
    request1.send(data1);
}

function select_bttn1(){
    let select_form = document.getElementById('insel_tab1');
    let request1 = new XMLHttpRequest();
    let data1 =JSON.stringify({
        "content" : select_form.value
    });
    request1.open("POST", "/admin/polyatabl", true);   
    request1.setRequestHeader("Content-Type", "application/json");
    request1.addEventListener("load", function () {
        main_obj.check_list(request1.response,select_form.value);
    });
    request1.send(data1);
}

function xlsx_bttn(){
    console.log('xlsx bttn')
    let bttn = document.getElementById('v-pills-messages');
        console.log(bttn.outerHTML)
        bttn.insertAdjacentHTML("beforeend","<br><a onclick='del_xlsx()' href='/public/table.xlsx' >Скачати файл</a>")
    let xlsx_value = document.getElementById('insel_tab1');
    let data = JSON.stringify({
        "content" : xlsx_value.value
    })
    let request = new XMLHttpRequest();
    request.open("POST", "/admin/jsontoxlsx", true);   
    request.setRequestHeader("Content-Type", "application/json");
    request.addEventListener("load", function () {
        console.log(request.responseText);
    });
    request.send(data);
}

function del_xlsx(){
    console.log('locationnnn')
    let request = new XMLHttpRequest();
    let data='';
    request.open("POST", "/admin/delxlsx", true);   
    request.setRequestHeader("Content-Type", "application/json");
    request.addEventListener("load", function () {
        console.log(request.responseText);
    });
    request.send(data);
}

function inp_tb(){
    let request = new XMLHttpRequest();
    let data =JSON.stringify({
        "content" : "*"
    });
    request.open("POST", "/admin/tabs", true);   
    request.setRequestHeader("Content-Type", "application/json");
    request.addEventListener("load", function () {
        main_obj.input1(request.response);
    });
    request.send(data);
}
function inp_tb1(){
    let request = new XMLHttpRequest();
    let data =JSON.stringify({
        "content" : "*"
    });
    request.open("POST", "/admin/tabs", true);   
    request.setRequestHeader("Content-Type", "application/json");
    request.addEventListener("load", function () {
        main_obj.xlsx_input(request.response);
    });
    request.send(data);
}
function inp_tb2(){
    let request = new XMLHttpRequest();
    let data =JSON.stringify({
        "content" : "*"
    });
    request.open("POST", "/admin/tabs", true);   
    request.setRequestHeader("Content-Type", "application/json");
    request.addEventListener("load", function () {
        main_obj.input3(request.response);
    });
    request.send(data);
}
function check_(){
    let list = document.getElementById('list');
    let tb_name = list.getAttribute('tb_name')
    let spysok = {};
    for(let i=0;i<list.childNodes.length-1;i++){
        //console.log(list.childNodes[i].placeholder,list.childNodes[i].value);
        spysok[list.childNodes[i].value] = list.childNodes[i].placeholder;
    }
    spysok["table"] = tb_name;
    //spysok = JSON.stringify(spysok)
    let list_html=`<form action="/admin/xlsx" enctype="multipart/form-data" method="POST">
            <div class="input-group mb-3">
                <button class="btn btn-outline-secondary" type="submit" id="inputGroupFileAddon03">Button</button>
                <input type="file"  name="xlsx1" class="form-control" id="inputGroupFile03" aria-describedby="inputGroupFileAddon03" aria-label="Upload">
                <input type="hidden" id='spysok' name="spysok">
            </div>
        </form>`
    
    let vstavka = document.getElementById('v-pills-home');
    vstavka.insertAdjacentHTML('beforeend', list_html);
    let spys = document.getElementById('spysok');
    spys.value = JSON.stringify(spysok);
}

function pokypka(){
    let pok_list = new XMLHttpRequest();
    pok_list.open("POST", "/admin/customer_pokypka", true);   
    pok_list.setRequestHeader("Content-Type", "application/json");
    pok_list.addEventListener("load", function () {
        let tabinner = document.getElementById('v-pills-settings');
        let data = pok_list.responseText;
        tabinner.innerHTML += '<select id="select_user" class="form-select form-select-sm" aria-label=".form-select-sm example"><option value="all">All</select>';
        let select_user = document.getElementById('select_user');
        data = JSON.parse(data);
        for(let elem of data){
            select_user.innerHTML+='<option value="'+elem.login+'">'+elem.name+" "+elem.username+'</option>';
        }
        tabinner.insertAdjacentHTML('beforeend','<button class="btn btn-primary" style="margin-top: 1rem;" onclick="select_user()">Вибрати</button>')
    });
    pok_list.send();
}
function select_user(){
    let data_form = document.getElementById('select_user');
    let data = JSON.stringify({
        'username' : data_form.value
    })
    console.log(data)
    let select_user = new XMLHttpRequest();
    select_user.open("POST", "/admin/select_user", true);   
    select_user.setRequestHeader("Content-Type", "application/json");
    select_user.addEventListener("load", function () {
        console.log(select_user.responseText)
        let tabinner = document.getElementById('v-pills-settings');
        let stroka = '<table id="table_inf" class="table"><thead><tr>';
        //let table_inf = document.getElementById(table_inf);
        let inform = JSON.parse(select_user.responseText)
        for(let keys in inform[0]){
                stroka+= '<th scope="col">'+keys+'</th>';
            }
            stroka += '</thead><tbody>'
            for(let elem of inform){
                let products_list = elem.products;
                let k = 0
                products_list = splitString(products_list,","); //  тут лишній елемент
                console.log(products_list)
                for(let pos of products_list){
                    if(pos != ""){
                        if(k==0){
                        stroka+='<tr>';
                    stroka+=`<th scope="row">`+elem.id_pokypku+`</th>
                        <td>`+pos+`</td>
                        <td>`+elem.client_id+`</td>
                       <td>`+elem.adress+`</td>
                       <td>`+elem.date+`</td>
                       <td>`+elem.status+`</td>
                       <td>`+'<button onclick="print_page('+elem.id_pokypku+')" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">вибір</button>'+`</td>`;
                    stroka+='</tr>';
                    }else{
                        stroka+='<tr>';
                        stroka+=`<th scope="row"></th>
                        <td>`+pos+`</td>
                        <td></td>
                       <td></td>
                       <td></td>`
                        stroka+='</tr>';
                    }
                    k++
                    }
                    
                }
                k=0;
            }
            stroka+='</tbody></table>';
        if(tabinner.childNodes.length<=5){
            tabinner.insertAdjacentHTML('beforeend', stroka);
        }else{
            let table_node = document.getElementById('table_inf');
            table_node.remove();
            tabinner.insertAdjacentHTML('beforeend', stroka);
        }
    });
    select_user.send(data)
}
function print_page(x){
    let popup_content = document.getElementById('main-modal_content');
    popup_content.innerHTML = "<p>№"+x+"</p><br>"; 
    //let popup_menu = document.getElementById('staticBackdropLabel');
    let print_inf_data = JSON.stringify({
        "id_pokypku" : x
    })
    let print_inf = new XMLHttpRequest();
    print_inf.open("POST", "/admin/print_order", true);   
    print_inf.setRequestHeader("Content-Type", "application/json");
    print_inf.addEventListener("load", function () {
        //console.log(print_inf.response);
        let print_table = JSON.parse(print_inf.response);
        let print_inf_table = '<table id="popup_table" class="table"><thead><tr>';
        
        print_inf_table+= '<th scope="col">#</th><th scope="col">назва</th><th scope="col">кількість</th><th scope="col">ціна</th>';
        
        print_inf_table += '</thead><tbody>';
        let products_list = splitString(print_table[0].products,",");
        let kilk = 1;
        for(let i =0;i<products_list.length-1;i++){
            print_inf_table+='<tr>';
            let all = splitString(products_list[i],":")
            let name = all[0];
            let count = all[1];
            let price = all[2];
            print_inf_table+='<td>'+kilk+'</td><td>'+name+'</td><td>'+count+'</td><td>'+price+'</td>'
            kilk++;
            print_inf_table+='</tr>';
        }
        print_inf_table+='</tbody></table>';
        popup_content.innerHTML+= print_inf_table;
        popup_content.innerHTML+= "<p>"+print_table[0].client_id+"</p>";
        popup_content.innerHTML+= "<p>Адреса: "+print_table[0].adress+"</p>";
        (function(){
            let suma = 0;
            let popup_table = document.getElementById('popup_table');
            //console.log(popup_table.childNodes[1])
            for(let i = 0;i<popup_table.childNodes[1].childNodes.length;i++){
                suma += parseInt(popup_table.childNodes[1].childNodes[i].childNodes[3].innerHTML)
            }
            popup_table.insertAdjacentHTML('afterend','<p>Загальна сума: '+suma+'</p><br>')
        }())
    });
    print_inf.send(print_inf_data)
}
function PrintMe(DivID) {
var disp_setting="toolbar=yes,location=no,";
disp_setting+="directories=yes,menubar=yes,";
disp_setting+="scrollbars=yes,width=650, height=600, left=100, top=25";
   var content_vlue = document.getElementById(DivID).innerHTML;
   var docprint=window.open("","",disp_setting);
   docprint.document.open();
   docprint.document.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"');
   //docprint.document.write('"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">');
   //docprint.document.write('<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">');
   docprint.document.write('<head><title>Чек</title>');
   //docprint.document.write('<style type="text/css">body{ margin:0px;');
  // docprint.document.write('font-family:verdana,Arial;color:#000;');
   //docprint.document.write('font-family:Verdana, Geneva, sans-serif; font-size:12px;}');
   //docprint.document.write('a{color:#000;text-decoration:none;} </style>');
   docprint.document.write('</head><body onLoad="self.print()"><center>');
   docprint.document.write(content_vlue);
   docprint.document.write('</center></body></html>');
   docprint.document.close();
   docprint.focus();
}
function done(x){
    let code = x.parentElement.parentElement.childNodes[3].childNodes[0].innerHTML;
    code = code.slice(1,code.length);
    let remove_data = JSON.stringify({
        "id" : code
    })
    let remove = new XMLHttpRequest();
    remove.open("POST", "/admin/remove_to_archive", true);   
    remove.setRequestHeader("Content-Type", "application/json");
    remove.addEventListener("load", function () {
    })
    remove.send(remove_data)
}
</script>





    